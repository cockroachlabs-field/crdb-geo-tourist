<!DOCTYPE html>
<html>
<head>
	<title>CRDB Geo Tourist</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="/static/leaflet.css"/>
  <script src="/static/leaflet.js"></script>
  <script src="/static/jquery-3.5.1.min.js"></script>
  <link rel="icon" type="image/png" href="/static/crl-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="/static/crl-32x32.png?w=16h=16" sizes="16x16">

  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html, body, #mapid {
      height: 100%;
      width: 100%;
    }
  </style>

</head>
<body>

<div id="mapid"></div>

<script>

  // A set of places where the map may be centered, since it's a simulation and not based
  // on the actual position of the user.
  var points = []
  highPubDensity = [51.51214599609375, -0.0823974609375];
  points.push(highPubDensity);

  britishMuseum = [51.519844, -0.126731];
  points.push(britishMuseum);

  trafalgarSquare = [51.506712, -0.127235];
  points.push(trafalgarSquare);

  boroughMarket = [51.505435, -0.090446];
  points.push(boroughMarket);

  tateModern = [51.508337, -0.099281];
  points.push(tateModern);

  hampstead = [51.556611, -0.163281];
  points.push(hampstead);

  stJamesPark = [51.576594, -0.035910];
  points.push(stJamesPark);

  dublin = [53.346028, -6.279658];
  points.push(dublin);

  munich = [48.135056, 11.576097];
  points.push(munich);

  // Assign a random point of interest
  let myLat, myLon;
  [myLat, myLon] = points[Math.floor(Math.random() * points.length)];

  var mymap = L.map('mapid').setView([myLat, myLon], 16);

  var personIcon = L.icon({
    iconUrl: '/static/person_icon.png',
    iconSize:     [36, 68], // size of the icon
    iconAnchor:   [32, 0], // point of the icon which will correspond to marker's location
    popupAnchor:  [11, 11] // point from which the popup should open relative to the iconAnchor
  });

  var pubIcon = L.icon({
    iconUrl: '/static/pub_icon.png',
    iconSize:     [24, 28], // size of the icon
    iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
    popupAnchor:  [11, 11] // point from which the popup should open relative to the iconAnchor
  });

  var barIcon = L.icon({
    iconUrl: '/static/bar_icon.png',
    iconSize:     [24, 28], // size of the icon
    iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
    popupAnchor:  [11, 11] // point from which the popup should open relative to the iconAnchor
  });

  var cafeIcon = L.icon({
    iconUrl: '/static/cafe_icon.png',
    iconSize:     [24, 28], // size of the icon
    iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
    popupAnchor:  [11, 11] // point from which the popup should open relative to the iconAnchor
  });

  var restaurantIcon = L.icon({
    iconUrl: '/static/restaurant_icon.png',
    iconSize:     [24, 28], // size of the icon
    iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
    popupAnchor:  [11, 11] // point from which the popup should open relative to the iconAnchor
  });

  let iconMap = new Map();
  iconMap.set("pub", pubIcon);
  iconMap.set("bar", barIcon);
  iconMap.set("cafe", cafeIcon);
  iconMap.set("restaurant", restaurantIcon);

  // Add base map
  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={{mapbox_token}}', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
      '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1
  }).addTo(mymap);

  // Type of amenity (pub, cafe, bar, restaurant, ...)
  var amenityTypes = ["restaurant", "pub", "cafe", "bar"];
  var amenity = amenityTypes[Math.floor(Math.random() * amenityTypes.length)];

  // This is where I'm located
  L.marker([myLat, myLon], {icon: personIcon}).addTo(mymap).bindPopup("<b>Show me the closest " + amenity + "s!</b>").openPopup();

  // Add data points
  $.post("/features",
    JSON.stringify({ "amenity": amenity, "lat": myLat, "lon": myLon }),
    function(data) {
      data.forEach(function(obj) {
        L.marker(
          [obj.lat, obj.lon],
          {icon: iconMap.get(amenity)}).addTo(mymap).bindPopup("<b>" + obj.name + "</b><br/>" + obj.dist_m + " meters");
      })
    },
    "json"
  );
</script>
</body>
</html>

